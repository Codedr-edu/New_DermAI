<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cơ sở y tế gần tôi - DermAI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background: linear-gradient(135deg, #f8fafc 0%, #e8f0ff 100%); }
        .map-card { max-width:980px; margin:18px auto; border-radius:12px; overflow:hidden; box-shadow:0 10px 25px rgba(15,23,42,0.08); background:#fff;margin-bottom:20vh; }
        #map { height: 60vh; min-height: 360px; margin-bottom: 10px; }
        .search-row { padding:12px; }
        .pharmacy-list { max-height:30vh; overflow:auto; }
        .pharmacy-item { cursor:pointer; }
        .brand { font-weight:700; }
        .hint { font-size:0.9rem; color:#6b7280; }
        /* reuse bottom navbar styling similar to home.html */
        nav.navbar { box-shadow: 0 -1px 0 rgba(0,0,0,0.05); }
    </style>
</head>
<body class="d-flex flex-column align-items-center vh-100" data-auth="{{ request.user.is_authenticated|yesno:'true,false' }}">
    <div class="container vh-100">
        <div class="d-flex align-items-center justify-content-between py-3">
            <div class="d-flex align-items-center">
                <div class="brand fs-4 me-3">DermAI</div>
                <div class="hint text-muted" id="mainHint">Tìm nhà thuốc gần vị trí của bạn</div>
            </div>
            <div class="text-end text-muted small">Bản đồ powered by OpenStreetMap</div>
        </div>

        <div class="map-card" style="margin-bottom: 20vh;">
            <div class="search-row d-flex gap-2 align-items-center border-bottom">
                <div class="flex-fill d-flex gap-2">
                    <input id="locationSearch" class="form-control" placeholder="Nhập địa chỉ/thành phố nếu GPS không hoạt động" />
                    <button id="searchBtn" class="btn btn-outline-primary">Tìm</button>
                </div>
                <div>
                    <select id="typeSelect" class="form-select" style="min-width: 120px;">
                        <option value="pharmacy" selected>Nhà thuốc</option>
                        <option value="hospital">Bệnh viện</option>
                        <option value="clinic">Phòng khám</option>
                    </select>
                </div>
                <div>
                    <select id="radiusSelect" class="form-select">
                        <option value="1000">1 km</option>
                        <option value="2000">2 km</option>
                        <option value="5000" selected>5 km</option>
                        <option value="10000">10 km</option>
                    </select>
                </div>
            </div>

            <div id="map"></div>

            <div class="p-3">
                <div class="row gx-3 gy-3">
                    <!-- On small screens, list comes first and spans full width. On md+ screens, list uses remaining space and hints sit to the right. -->
                    <div class="col-12 col-md-8 order-1 order-md-1">
                        <h6 id="listTitle">Nhà thuốc gần đây</h6>
                        <div id="list" class="pharmacy-list list-group"></div>
                    </div>
                    <div class="col-12 col-md-4 order-2 order-md-2">
                        <div class="small text-muted">Gợi ý</div>
                        <div class="bg-light p-2 rounded">
                            <ul class="mb-0">
                                <li>Cho phép truy cập vị trí khi được hỏi để tìm nhanh nhất.</li>
                                <li>Nếu không cho phép, hãy nhập địa chỉ hoặc tên quận / thành phố và nhấn "Tìm".</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div style="margin-bottom: 10vh;"></div>

    <!-- bottom navbar copied from home.html to preserve style -->
    <nav class="navbar navbar-light bg-white border-top fixed-bottom">
      <div class="container d-flex justify-content-around py-2">
        <a href="#" class="d-flex flex-column align-items-center text-decoration-none text-muted" aria-current="page">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16">
            <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
            <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0"/>
          </svg>
        </a>

        <!--<a href="/community" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-square-quote-fill" viewBox="0 0 16 16">
            <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2zm7.194 2.766a1.7 1.7 0 0 0-.227-.272 1.5 1.5 0 0 0-.469-.324l-.008-.004A1.8 1.8 0 0 0 5.734 4C4.776 4 4 4.746 4 5.667c0 .92.776 1.666 1.734 1.666.343 0 .662-.095.931-.26-.137.389-.39.804-.81 1.22a.405.405 0 0 0 .011.59c.173.16.447.155.614-.01 1.334-1.329 1.37-2.758.941-3.706a2.5 2.5 0 0 0-.227-.4zM11 7.073c-.136.389-.39.804-.81 1.22a.405.405 0 0 0 .012.59c.172.16.446.155.613-.01 1.334-1.329 1.37-2.758.942-3.706a2.5 2.5 0 0 0-.228-.4 1.7 1.7 0 0 0-.227-.273 1.5 1.5 0 0 0-.469-.324l-.008-.004A1.8 1.8 0 0 0 10.07 4c-.957 0-1.734.746-1.734 1.667 0 .92.777 1.666 1.734 1.666.343 0 .662-.095.931-.26"/>
          </svg>
        </a>-->

        <a href="/chatbot" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mb-1" viewBox="0 0 16 16">
            <path d="M2 2h12v9H5.414L3 13.414V2z"/>
          </svg>
        </a>

        <a href="/pharmacy" class="d-flex flex-column align-items-center text-decoration-none text-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-capsule-pill" viewBox="0 0 16 16">
            <path d="M11.02 5.364a3 3 0 0 0-4.242-4.243L1.121 6.778a3 3 0 1 0 4.243 4.243l5.657-5.657Zm-6.413-.657 2.878-2.879a2 2 0 1 1 2.829 2.829L7.435 7.536zM12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8m-.5 1.042a3 3 0 0 0 0 5.917zm1 5.917a3 3 0 0 0 0-5.917z"/>
          </svg>
        </a>
        
        <a href="tel:115" class="d-flex flex-column align-items-center text-decoration-none text-danger">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mb-1" viewBox="0 0 16 16">
            <path d="M3.654 1.328a.678.678 0 00-1.015-.063L1.605 2.298c-.483.48-.661 1.18-.45 1.803.35 1.098 1.07 2.78 2.65 4.36 1.58 1.58 3.262 2.3 4.36 2.65.623.211 1.323.033 1.803-.45l1.033-1.033a.678.678 0 00-.063-1.015l-2.07-1.552a.678.678 0 00-.58-.087l-1.52.507a.678.678 0 01-.657-.148L6.9 6.1a.678.678 0 00-.148-.657L6.255 4.9a.678.678 0 00-.087-.58L4.616 2.25z"/>
          </svg>
          <!--<small class="d-block">Gọi cấp cứu</small>-->
        </a>

        <a href="/profile" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
          </svg>
        </a>
      </div>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Read auth flag (kept from home.html pattern)
        const IS_AUTHENTICATED = document.body && document.body.dataset ? document.body.dataset.auth === 'true' : false;

        let currentLat, currentLon;

        function haversine(lat1, lon1, lat2, lon2){
            function toRad(x){ return x * Math.PI / 180; }
            const R = 6371000; // m
            const dLat = toRad(lat2-lat1);
            const dLon = toRad(lon2-lon1);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        let map, userMarker, markersLayer;

        function initMap(lat, lon){
            if(!map){
                map = L.map('map').setView([lat, lon], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                markersLayer = L.layerGroup().addTo(map);
            } else {
                map.setView([lat, lon], 14);
                markersLayer.clearLayers();
            }
            if(userMarker) {
                userMarker.setLatLng([lat, lon]);
            } else {
                // show user location as a styled circle marker
                userMarker = L.circleMarker([lat, lon], {radius:6, color:'#0d6efd', fillColor:'#0d6efd', fillOpacity:0.9}).addTo(map).bindPopup('Bạn ở đây').openPopup();
            }
        }

        async function fetchLocations(type, lat, lon, radius){
            const amenity = type === 'pharmacy' ? 'pharmacy' : type === 'hospital' ? 'hospital' : 'clinic';
            const query = `
                [out:json][timeout:25];
                (
                  node["amenity"="${amenity}"](around:${radius},${lat},${lon});
                  way["amenity"="${amenity}"](around:${radius},${lat},${lon});
                  relation["amenity"="${amenity}"](around:${radius},${lat},${lon});
                );
                out center;
            `;
            try{
                const resp = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body: 'data=' + encodeURIComponent(query)
                });
                const data = await resp.json();
                const items = (data.elements||[]).map(el=>{
                    let elLat = el.lat || (el.center && el.center.lat);
                    let elLon = el.lon || (el.center && el.center.lon);
                    return { id: el.id, lat: elLat, lon: elLon, tags: el.tags || {} };
                }).filter(it=>it.lat && it.lon);
                // compute distances
                items.forEach(it=>{ it.dist = haversine(lat, lon, it.lat, it.lon); });
                items.sort((a,b)=>a.dist - b.dist);
                return items;
            }catch(e){ console.error('Overpass failed', e); return []; }
        }

        function renderList(type, items){
            const list = document.getElementById('list'); list.innerHTML='';
            const defaultName = type === 'pharmacy' ? 'Nhà thuốc' : type === 'hospital' ? 'Bệnh viện' : 'Phòng khám';
            items.forEach((it, idx)=>{
                const name = it.tags.name || defaultName;
                const addr = [it.tags['addr:street'], it.tags['addr:city']].filter(Boolean).join(', ');
                const li = document.createElement('a');
                li.className = 'list-group-item list-group-item-action pharmacy-item';
                li.innerHTML = `<div class="d-flex justify-content-between"><div><strong>${name}</strong><div class="small text-muted">${addr}</div></div><div class="text-end small">${(it.dist/1000).toFixed(2)} km</div></div>`;
                li.href = '#';
                li.addEventListener('click', (ev)=>{ ev.preventDefault(); map.setView([it.lat, it.lon], 17); });
                list.appendChild(li);
            });
        }

        function placeMarkers(type, items){
            markersLayer.clearLayers();
            const defaultName = type === 'pharmacy' ? 'Nhà thuốc' : type === 'hospital' ? 'Bệnh viện' : 'Phòng khám';
            items.forEach(it=>{
                const name = it.tags.name || defaultName;
                const popup = `<div><strong>${name}</strong><div class="small text-muted">${it.tags.operator || ''}</div><div class="small">${(it.dist/1000).toFixed(2)} km</div></div>`;
                const m = L.marker([it.lat, it.lon]).bindPopup(popup);
                markersLayer.addLayer(m);
            });
        }

        function updateTitles(type) {
            const listTitles = {
                'pharmacy': 'Nhà thuốc gần đây',
                'hospital': 'Bệnh viện gần đây',
                'clinic': 'Phòng khám gần đây'
            };
            document.getElementById('listTitle').textContent = listTitles[type] || 'Cơ sở y tế gần đây';

            const mainHints = {
                'pharmacy': 'Tìm nhà thuốc gần vị trí của bạn',
                'hospital': 'Tìm bệnh viện gần vị trí của bạn',
                'clinic': 'Tìm phòng khám gần vị trí của bạn'
            };
            document.getElementById('mainHint').textContent = mainHints[type] || 'Tìm cơ sở y tế gần vị trí của bạn';

            const pageTitles = {
                'pharmacy': 'Nhà thuốc gần tôi - DermAI',
                'hospital': 'Bệnh viện gần tôi - DermAI',
                'clinic': 'Phòng khám gần tôi - DermAI'
            };
            document.title = pageTitles[type] || 'Cơ sở y tế gần tôi - DermAI';
        }

        async function tryLocateAndShow(){
            function onFound(lat, lon){
                currentLat = lat;
                currentLon = lon;
                initMap(lat, lon);
                const type = document.getElementById('typeSelect').value || 'pharmacy';
                const radius = parseInt(document.getElementById('radiusSelect').value || '5000',10);
                fetchLocations(type, lat, lon, radius).then(items=>{ 
                    renderList(type, items); 
                    placeMarkers(type, items); 
                    updateTitles(type);
                });
            }

            // Try navigator.geolocation first
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(async pos=>{
                    onFound(pos.coords.latitude, pos.coords.longitude);
                }, async err=>{
                    console.warn('Geolocation denied/fail:', err);
                    // fallback to IP-based lookup
                    try{
                        const r = await fetch('https://ipapi.co/json/');
                        const ipdata = await r.json();
                        if(ipdata && ipdata.latitude && ipdata.longitude){
                            onFound(parseFloat(ipdata.latitude), parseFloat(ipdata.longitude));
                        } else {
                            // show an empty map (center Vietnam) and message
                            initMap(21.028511,105.804817); // Hanoi center fallback
                            document.getElementById('list').innerHTML = '<div class="text-muted">Không thể xác định vị trí. Hãy nhập địa chỉ thủ công.</div>';
                            const type = document.getElementById('typeSelect').value || 'pharmacy';
                            updateTitles(type);
                        }
                    }catch(e){
                        console.error('IP geolocation failed', e);
                        initMap(21.028511,105.804817);
                        document.getElementById('list').innerHTML = '<div class="text-muted">Không thể xác định vị trí. Hãy nhập địa chỉ thủ công.</div>';
                        const type = document.getElementById('typeSelect').value || 'pharmacy';
                        updateTitles(type);
                    }
                }, { enableHighAccuracy: true, timeout: 8000 });
            } else {
                // no geolocation API
                try{
                    const r = await fetch('https://ipapi.co/json/');
                    const ipdata = await r.json();
                    if(ipdata && ipdata.latitude && ipdata.longitude){ onFound(parseFloat(ipdata.latitude), parseFloat(ipdata.longitude)); }
                }catch(e){ 
                    initMap(21.028511,105.804817); 
                    document.getElementById('list').innerHTML = '<div class="text-muted">Không thể xác định vị trí. Hãy nhập địa chỉ thủ công.</div>';
                    const type = document.getElementById('typeSelect').value || 'pharmacy';
                    updateTitles(type);
                }
            }
        }

        // Hook up search button (Nominatim geocoding)
        document.addEventListener('DOMContentLoaded', ()=>{
            // Type select change listener
            document.getElementById('typeSelect').addEventListener('change', async (ev) => {
                const type = ev.target.value;
                if (currentLat && currentLon) {
                    const radius = parseInt(document.getElementById('radiusSelect').value || '5000', 10);
                    try {
                        const items = await fetchLocations(type, currentLat, currentLon, radius);
                        renderList(type, items);
                        placeMarkers(type, items);
                        updateTitles(type);
                    } catch (e) {
                        console.error('Refetch on type change failed', e);
                    }
                }
            });

            document.getElementById('searchBtn').addEventListener('click', async ()=>{
                const q = document.getElementById('locationSearch').value.trim();
                if(!q) return tryLocateAndShow();
                try{
                    const resp = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q));
                    const results = await resp.json();
                    if(results && results[0]){
                        const lat = parseFloat(results[0].lat), lon = parseFloat(results[0].lon);
                        currentLat = lat;
                        currentLon = lon;
                        initMap(lat, lon);
                        const type = document.getElementById('typeSelect').value || 'pharmacy';
                        const radius = parseInt(document.getElementById('radiusSelect').value||'5000',10);
                        const items = await fetchLocations(type, lat, lon, radius);
                        renderList(type, items); placeMarkers(type, items);
                        updateTitles(type);
                    } else {
                        alert('Không tìm thấy địa điểm, thử nhập cụ thể hơn.');
                    }
                }catch(e){ console.error(e); alert('Lỗi khi tìm địa điểm.'); }
            });

            // initial attempt to locate
            tryLocateAndShow();
            updateTitles(document.getElementById('typeSelect').value || 'pharmacy');
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
