<!doctype html>
<html lang="vi">
<head>
    <meta property="og:title" content="DermAI - Ứng dụng AI hỗ trợ chẩn đoán bệnh da liễu">
    <meta property="og:description" content="Ứng dụng AI hỗ trợ chẩn đoán các bệnh về da liễu nhanh chóng và chính xác. Sử dụng trí tuệ nhân tạo và thị giác máy tính để phân tích hình ảnh da và cung cấp các chẩn đoán kịp thời.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://litclub.pythonanywhere.com/">
    <meta property="og:image" content="https://scontent.fhan15-2.fna.fbcdn.net/v/t39.30808-6/517737809_122100053498943826_3327007350081078447_n.png?_nc_cat=107&ccb=1-7&_nc_sid=cc71e4&_nc_ohc=edONUK9z7kkQ7kNvwGrcQv7&_nc_oc=AdkRdS-VL0_JPfxBJv-XMhR_XPRw6BcxfGIvM441XgvNj4YQEuV7E0WNzscIUV9WT8I&_nc_zt=23&_nc_ht=scontent.fhan15-2.fna&_nc_gid=oQXmcf39N5CEF7QDQIN0hw&oh=00_AfTGO5IfzsEbxFCqddWx-S-7SJlJnywSnTXyjgdq0DteCQ&oe=68801A5D">
    <meta property="og:site_name" content="DermAI - Ứng dụng AI hỗ trợ chẩn đoán bệnh da liễu">

    <link rel="shortcut icon" href="https://github.com/Codedr-edu/DermAI/blob/main/media/Thi%E1%BA%BFt%20k%E1%BA%BF%20ch%C6%B0a%20c%C3%B3%20t%C3%AAn.png?raw=true" type="image/x-icon">

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chụp ảnh - DermAI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e8f0ff 100%);
        }
        .card-camera {
            width: 360px;
            border: 0;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
            overflow: visible;
        }
        .camera-frame {
            width: 300px;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border: 2px solid rgba(0,0,0,0.06);
        }
        .camera-frame video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        #captureCanvas { display: none; }
        .brand {
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        .hint {
            font-size: 0.9rem;
            color: #6b7280;
        }

        /* New styles for circular capture button */
        .btn-circle {
            width: 72px;
            height: 72px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 18px rgba(13,110,253,0.18);
            transition: transform .08s ease, box-shadow .08s ease;
        }
        .btn-circle:active { transform: scale(.98); }
        .btn-circle .camera-icon svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        .btn-circle .spinner-border {
            width: 1.25rem;
            height: 1.25rem;
            border-width: .18em;
        }
        /* Keep small stop button aligned */
        .controls-row { gap: 12px; }
    </style>
</head>
<body class="d-flex vh-100" data-auth="{{ request.user.is_authenticated|yesno:'true,false' }}">
    <script>
        // Read authentication state from a data attribute to avoid embedding Django template
        // tags directly inside JavaScript (prevents editor/JS-linter from showing parse errors).
        window.IS_AUTHENTICATED = document.body && document.body.dataset ? document.body.dataset.auth === 'true' : false;
    </script>
    <div class="container d-flex align-items-center justify-content-center">
        <!--<a href="" class="btn btn-primary">Login</a>-->
        <div class="card card-camera p-4 text-center bg-white">
            <div class="mb-3">
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="#0d6efd" class="me-2" viewBox="0 0 16 16">
                        <path d="M10.5 2a1 1 0 0 0-.832.445L8.94 4H7.06L6.332 2.445A1 1 0 0 0 5.5 2h-3A1.5 1.5 0 0 0 1 3.5v9A1.5 1.5 0 0 0 2.5 14h11A1.5 1.5 0 0 0 15 12.5v-9A1.5 1.5 0 0 0 13.5 2h-3zM8 12a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    <div class="brand">DermAI</div>
                </div>
                <div class="hint">Chụp vùng da để kiểm tra - camera 300×300</div>
            </div>

            <div class="camera-frame mb-3">
                <video id="video" autoplay playsinline muted></video>
            </div>

            <div class="d-flex justify-content-center align-items-center controls-row">
                <button id="flipBtn" type="button" class="btn btn-light rounded-circle shadow" aria-label="Chuyển camera" style="right:calc(50% - 36px);width:44px;height:44px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                    </svg>
                </button>
                <!-- Circular capture button with camera icon -->
                <button id="snapBtn" class="btn btn-primary btn-circle" type="button"  aria-label="Chụp ảnh">
                    <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <span id="cameraIcon" class="camera-icon" aria-hidden="true">
                        <!-- camera SVG icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16">
                            <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
                            <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0"/>
                        </svg>
                    </span>

                    <!--<script>
                        // Replace the visible "Dừng" button with an Upload button placed to the right of the capture button.
                        // Keep the original #stopBtn hidden in DOM so existing JS references still work.
                        (function () {
                            function showLoginPromptLocal() {
                                const modalEl = document.getElementById('loginModal');
                                if (!modalEl) return;
                                if (window.bootstrap && typeof bootstrap.Modal === 'function') {
                                    try {
                                        const m = new bootstrap.Modal(modalEl);
                                        m.show();
                                        return;
                                    } catch (e) { /* fallthrough */ }
                                }
                                // fallback manual show
                                modalEl.classList.add('show');
                                modalEl.style.display = 'block';
                                modalEl.setAttribute('aria-hidden', 'false');
                                let backdrop = document.querySelector('.modal-backdrop.show');
                                if (!backdrop) {
                                    backdrop = document.createElement('div');
                                    backdrop.className = 'modal-backdrop fade show';
                                    document.body.appendChild(backdrop);
                                }
                            }

                            function initReplace() {
                                const snapBtn = document.getElementById('snapBtn');
                                const stopBtn = document.getElementById('stopBtn');
                                const fileInput = document.getElementById('fileInput');
                                if (!snapBtn || !stopBtn || !fileInput) return;

                                // Hide the inline label inside snapBtn (so upload UI is only on the right)
                                const inlineLabel = snapBtn.querySelector('label[for="fileInput"]');
                                if (inlineLabel) inlineLabel.style.display = 'none';

                                // Keep stopBtn in DOM for existing script references but hide it visually
                                stopBtn.style.display = 'none';

                                // Create a visible upload button to the right of the capture button
                                const uploadBtn = document.createElement('button');
                                uploadBtn.type = 'button';
                                uploadBtn.id = 'uploadReplaceBtn';
                                uploadBtn.className = 'btn btn-light rounded-circle shadow';
                                //uploadBtn.title = 'Tải ảnh từ thư viện';
                                uploadBtn.style = 'right:calc(50% - 36px);width:44px;height:44px;';
                                uploadBtn.setAttribute('aria-label', 'Tải ảnh từ thư viện');
                                uploadBtn.innerHTML = `
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-image-fill" viewBox="0 0 16 16" aria-hidden="true" style="margin-right:6px;">
                                        <path d="M4.502 1a1 1 0 0 0-.998 1v10a1 1 0 0 0 .998 1h7a1 1 0 0 0 .998-1V2a1 1 0 0 0-.998-1h-7zm1 3a1 1 0 1 1 0-2 1 1 0 0 1 0 2zM2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2z"/>
                                    </svg>
                                `;

                                // Insert after snapBtn
                                snapBtn.parentNode.insertBefore(uploadBtn, snapBtn.nextSibling);

                                // Clicking upload opens existing hidden file input only when authenticated,
                                // otherwise show login modal.
                                uploadBtn.addEventListener('click', () => {
                                    if (window.IS_AUTHENTICATED) {
                                        fileInput.click();
                                    } else {
                                        showLoginPromptLocal();
                                    }
                                });

                                // Intercept visible label click (the small image icon) to require authentication too.
                                const visibleLabel = snapBtn.parentNode.querySelector('label[for="fileInput"]');
                                if (visibleLabel) {
                                    visibleLabel.addEventListener('click', function (ev) {
                                        if (!window.IS_AUTHENTICATED) {
                                            ev.preventDefault();
                                            ev.stopPropagation();
                                            showLoginPromptLocal();
                                        } // otherwise allow default (label will open file picker)
                                    }, { passive: false });
                                }
                            }

                            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                                setTimeout(initReplace, 10);
                            } else {
                                document.addEventListener('DOMContentLoaded', initReplace);
                            }
                        })();
                    </script> -->

                    <!-- hidden file input to upload image from library -->
                    <input id="fileInput" type="file" accept="image/*" class="d-none" />

                    <!-- visible upload icon (opens file picker) -->
                    <!--<label for="fileInput" class="ms-2" title="Tải ảnh từ thư viện" style="display:inline-flex;align-items:center;justify-content:center;cursor:pointer;" onclick="if(!window.IS_AUTHENTICATED){ if(window.bootstrap && typeof bootstrap.Modal === 'function'){ new bootstrap.Modal(document.getElementById('loginModal')).show(); } else { const m=document.getElementById('loginModal'); if(m){ m.classList.add('show'); m.style.display='block'; m.setAttribute('aria-hidden','false'); const b=document.createElement('div'); b.className='modal-backdrop fade show'; document.body.appendChild(b);} } return false;}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-image-fill" viewBox="0 0 16 16" aria-hidden="true">
                            <path d="M4.502 1a1 1 0 0 0-.998 1v10a1 1 0 0 0 .998 1h7a1 1 0 0 0 .998-1V2a1 1 0 0 0-.998-1h-7zm1 3a1 1 0 1 1 0-2 1 1 0 0 1 0 2zM2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2z"/>
                        </svg>
                    </label>
                </button>-->
                <canvas id="canvas" style="display: none;" width="300" height="300"></canvas>

            <!-- hidden form for POST so browser will follow server redirect -->
                <form id="uploadForm" name="uploadForm" action="{% url 'upload_image' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="image" id="imageInput" />
                </form>

                <button data-bs-toggle="modal" data-bs-target="#exampleModal" type="button" class="btn btn-light rounded-circle shadow" aria-label="Chuyển camera" style="right:calc(50% - 36px);width:44px;height:44px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                    </svg>
                </button>
                    
                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Upload ảnh để chẩn đoán</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="post" action="/upload/file/" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="formFile" class="form-label">Chọn ảnh từ thiết bị của bạn</label>
                                    <input class="form-control" type="file" id="image" name="image" accept="image/*" required onchange="handleFileSelect(this)">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Upload</button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="stopBtn" hidden class="btn btn-outline-secondary w-100">Dừng</button>
            <div class="w-100 rounded" style="height: 4px;background-color: #6b7280;margin-bottom: 10px;margin-top: 10px;"></div>
            <div class="d-flex justify-content-center align-items-center controls-row">
                <a href="tel:115" class="btn btn-danger rounded w-100 shadow" aria-label="Chuyển camera" style="right:calc(50% - 36px);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-telephone-fill" style="margin-right: 5px;" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z"/>
                    </svg> Gọi Cấp Cứu
                </a>
            </div>

            <div class="mt-3 hint">Ảnh sẽ được gửi để kiểm tra; nếu server xử lý sẽ chuyển trang kết quả tự động.</div>

            <!-- hidden canvas for processing -->
        </div>
    </div>

    <!-- Login prompt modal -->
    <div class="modal fade w-100" id="loginModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <h5 class="mb-2">Bạn chưa đăng nhập</h5>
            <p class="mb-3 text-muted">Vui lòng đăng nhập để sử dụng tính năng chụp và gửi ảnh.</p>
            <div class="d-flex justify-content-center gap-2">
              <a id="loginLink" href="/login" class="btn btn-primary">Đăng nhập</a>
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- floating camera-flip button (above navbar) -->

    <!-- bottom fixed navbar -->
    <nav class="navbar navbar-light bg-white border-top fixed-bottom">
      <div class="container d-flex justify-content-around py-2">
        <a href="#" class="d-flex flex-column align-items-center text-decoration-none text-primary" aria-current="page">
          <!-- simple camera icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16">
            <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
            <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0"/>
          </svg>
          <!--<small class="d-block">Nhận diện</small>-->
        </a>

        <!--<a href="/community" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-square-quote-fill" viewBox="0 0 16 16">
            <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2zm7.194 2.766a1.7 1.7 0 0 0-.227-.272 1.5 1.5 0 0 0-.469-.324l-.008-.004A1.8 1.8 0 0 0 5.734 4C4.776 4 4 4.746 4 5.667c0 .92.776 1.666 1.734 1.666.343 0 .662-.095.931-.26-.137.389-.39.804-.81 1.22a.405.405 0 0 0 .011.59c.173.16.447.155.614-.01 1.334-1.329 1.37-2.758.941-3.706a2.5 2.5 0 0 0-.227-.4zM11 7.073c-.136.389-.39.804-.81 1.22a.405.405 0 0 0 .012.59c.172.16.446.155.613-.01 1.334-1.329 1.37-2.758.942-3.706a2.5 2.5 0 0 0-.228-.4 1.7 1.7 0 0 0-.227-.273 1.5 1.5 0 0 0-.469-.324l-.008-.004A1.8 1.8 0 0 0 10.07 4c-.957 0-1.734.746-1.734 1.667 0 .92.777 1.666 1.734 1.666.343 0 .662-.095.931-.26z"/>
          </svg>
          <!--<small class="d-block">Cộng đồng</small>
        </a>-->

        <a href="/chatbot" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mb-1" viewBox="0 0 16 16">
            <path d="M2 2h12v9H5.414L3 13.414V2z"/>
          </svg>
          <!--<small class="d-block">Chatbot</small>-->
        </a>

        <a href="/pharmacy" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-capsule-pill" viewBox="0 0 16 16">
            <path d="M11.02 5.364a3 3 0 0 0-4.242-4.243L1.121 6.778a3 3 0 1 0 4.243 4.243l5.657-5.657Zm-6.413-.657 2.878-2.879a2 2 0 1 1 2.829 2.829L7.435 7.536zM12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8m-.5 1.042a3 3 0 0 0 0 5.917zm1 5.917a3 3 0 0 0 0-5.917z"/>
          </svg>
          <!--<small class="d-block">Nhà thuốc</small>-->
        </a>

        <a href="tel:115" class="d-flex flex-column align-items-center text-decoration-none text-danger">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mb-1" viewBox="0 0 16 16">
            <path d="M3.654 1.328a.678.678 0 00-1.015-.063L1.605 2.298c-.483.48-.661 1.18-.45 1.803.35 1.098 1.07 2.78 2.65 4.36 1.58 1.58 3.262 2.3 4.36 2.65.623.211 1.323.033 1.803-.45l1.033-1.033a.678.678 0 00-.063-1.015l-2.07-1.552a.678.678 0 00-.58-.087l-1.52.507a.678.678 0 01-.657-.148L6.9 6.1a.678.678 0 00-.148-.657L6.255 4.9a.678.678 0 00-.087-.58L4.616 2.25z"/>
          </svg>
          <!--<small class="d-block">Gọi cấp cứu</small>-->
        </a>

        <a href="/profile" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
          </svg>
          <!--<small class="d-block">Người dùng</small>-->
        </a>
      </div>
    </nav>

    <script>
    // NOTE: server may set window.IS_AUTHENTICATED before this script runs.
    // Prefer reading the data attribute to avoid embedding Django template tags inside JS.
    window.IS_AUTHENTICATED = document.body && document.body.dataset ? document.body.dataset.auth === 'true' : false;

        (function () {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const snapBtn = document.getElementById('snapBtn');
            const stopBtn = document.getElementById('stopBtn');
            const btnSpinner = document.getElementById('btnSpinner');
            const cameraIcon = document.getElementById('cameraIcon');
            const uploadForm = document.getElementById('uploadForm');
            const imageInput = document.getElementById('imageInput');
            const modalEl = document.getElementById('loginModal');
            const flipBtn = document.getElementById('flipBtn');
            const flipIcon = document.getElementById('flipIcon');
            const fileInput = document.getElementById('fileInput');

            console.log(uploadForm, imageInput);

            let stream = null;
            let fallbackBackdrop = null;
            let currentFacing = 'environment'; // 'environment' or 'user'

            stopBtn.disabled = true; // disabled until camera started

            async function startCamera() {
                try {
                    // stop existing first (safe)
                    stopCamera();

                    const constraints = {
                        video: {
                            facingMode: { ideal: currentFacing },
                            width: { ideal: 300 },
                            height: { ideal: 300 }
                        },
                        audio: false
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    stopBtn.disabled = false;
                } catch (err) {
                    console.error('Camera error:', err);
                    // try a looser constraint fallback if facingMode failed
                    try {
                        const fallback = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                        stream = fallback;
                        video.srcObject = stream;
                        stopBtn.disabled = false;
                    } catch (e) {
                        console.error('Fallback camera error:', e);
                        alert('Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thiết bị.');
                        stopBtn.disabled = true;
                    }
                }
            }

            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(t => t.stop());
                    stream = null;
                    video.srcObject = null;
                }
                stopBtn.disabled = true;
            }

            function showLoginPrompt() {
                if (window.bootstrap && typeof bootstrap.Modal === 'function') {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                    return;
                }
                modalEl.classList.add('show');
                modalEl.style.display = 'block';
                modalEl.setAttribute('aria-hidden', 'false');

                fallbackBackdrop = document.createElement('div');
                fallbackBackdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(fallbackBackdrop);
            }

            function hideLoginPrompt() {
                if (window.bootstrap && typeof bootstrap.Modal === 'function') {
                    return;
                }
                modalEl.classList.remove('show');
                modalEl.style.display = 'none';
                modalEl.setAttribute('aria-hidden', 'true');
                if (fallbackBackdrop) {
                    document.body.removeChild(fallbackBackdrop);
                    fallbackBackdrop = null;
                }
            }

            document.querySelectorAll('[data-bs-dismiss]').forEach(btn => {
                btn.addEventListener('click', hideLoginPrompt);
            });

            function handleFileSelect(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('exampleModal'));
                        if (modal) modal.hide();
                        // Stop camera and show selected image
                        stopCamera();
                        video.style.display = 'none';
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        video.parentNode.appendChild(img);
                        // Set the hidden form
                        imageInput.value = e.target.result;
                        // Submit
                        uploadForm.submit();
                    };
                    reader.readAsDataURL(file);
                }
            }

            window.handleFileSelect = handleFileSelect;

            function setProcessingState(on) {
                if (on) {
                    snapBtn.disabled = true;
                    btnSpinner.classList.remove('d-none');
                    cameraIcon.classList.add('d-none');

                    // Position flipBtn to the left of the capture button (visually)
                    if (!flipBtn.dataset.origPos) {
                        flipBtn.dataset.origPos = JSON.stringify({
                            position: flipBtn.style.position || '',
                            right: flipBtn.style.right || '',
                            bottom: flipBtn.style.bottom || '',
                            left: flipBtn.style.left || '',
                            top: flipBtn.style.top || '',
                            zIndex: flipBtn.style.zIndex || ''
                        });
                    }
                    // compute snap button position and place flip button left of it
                    const snapRect = snapBtn.getBoundingClientRect();
                    flipBtn.style.position = 'fixed';
                    flipBtn.style.left = (snapRect.left - flipBtn.offsetWidth - 12) + 'px';
                    flipBtn.style.top = (snapRect.top + (snapRect.height - flipBtn.offsetHeight) / 2) + 'px';
                    flipBtn.style.right = '';
                    flipBtn.style.bottom = '';
                    flipBtn.style.zIndex = '2000';

                    // Ensure stop button stops camera while processing
                    stopBtn.disabled = false;
                    stopBtn.textContent = 'Dừng';
                    stopBtn.onclick = function () {
                        stopCamera();
                        setProcessingState(false);
                        hideLoginPrompt();
                    };

                    // Observe spinner class so we can restore flipBtn and make stopBtn reopen camera when processing ends
                    if (flipBtn._restoreObserver) {
                        flipBtn._restoreObserver.disconnect();
                        flipBtn._restoreObserver = null;
                    }
                    const restoreObserver = new MutationObserver(() => {
                        if (btnSpinner.classList.contains('d-none')) {
                            // restore flip button original positioning
                            try {
                                const orig = JSON.parse(flipBtn.dataset.origPos || '{}');

                                // Restore saved inline styles (or clear them to let CSS handle positioning)
                                flipBtn.style.position = orig.position || '';
                                flipBtn.style.right = orig.right || '';
                                flipBtn.style.bottom = orig.bottom || '';
                                flipBtn.style.left = orig.left || '';
                                flipBtn.style.top = orig.top || '';
                                flipBtn.style.zIndex = orig.zIndex || '';

                                // If no explicit original coordinates were saved, put it back to bottom-center
                                if (!orig.position && !orig.left && !orig.right && !orig.top && !orig.bottom) {
                                    flipBtn.style.position = 'fixed';
                                    flipBtn.style.left = Math.round(window.innerWidth / 2 - flipBtn.offsetWidth / 2) + 'px';
                                    flipBtn.style.bottom = '76px';
                                    flipBtn.style.top = '';
                                    flipBtn.style.right = '';
                                    flipBtn.style.zIndex = '1050';
                                }

                                // small delay to ensure layout applied smoothly
                                setTimeout(() => {
                                    flipBtn.classList.remove('opacity-75');
                                }, 20);

                                // cleanup stored data
                                delete flipBtn.dataset.origPos;
                            } catch (e) {
                                // ignore parse errors silently
                            }
                            // make stop button reopen camera
                            stopBtn.textContent = 'Mở camera';
                            stopBtn.disabled = false;
                            stopBtn.onclick = async function () {
                                await startCamera();
                                setProcessingState(true);
                                hideLoginPrompt();
                            };
                            restoreObserver.disconnect();
                            flipBtn._restoreObserver = null;
                        }
                    });
                    restoreObserver.observe(btnSpinner, { attributes: true, attributeFilter: ['class'] });
                    flipBtn._restoreObserver = restoreObserver;

                    flipBtn.disabled = true;
                    flipBtn.disabled = true;
                } else {
                    snapBtn.disabled = false;
                    btnSpinner.classList.add('d-none');
                    cameraIcon.classList.remove('d-none');
                    flipBtn.disabled = false;
                }
            }

            async function captureAndSend() {
                if (!window.IS_AUTHENTICATED) {
                    showLoginPrompt();
                    return;
                }

                if (!stream || !stream.active) {
                    alert('Camera không hoạt động. Vui lòng khởi động lại.');
                    return;
                }

                if (!video || !video.srcObject || video.readyState < 4) {
                    alert('Camera chưa sẵn sàng, vui lòng chờ và thử lại.');
                    console.error('Video element not ready:', video);
                    return;
                }

                // Additional check: ensure video has dimensions loaded
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    alert('Video chưa tải đầy đủ, vui lòng chờ và thử lại.');
                    setProcessingState(false);
                    console.error('Video dimensions not available yet.');
                    return;

                }

                if (video.paused || video.ended) {
                    alert('Video không đang phát. Vui lòng thử lại.');
                    return;
                    console.error('Video element is paused or ended.'); 
                }

                setProcessingState(true);

                try {
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, 300, 300);
                    const dataUrl = canvas.toDataURL('image/jpeg', 1.0);
                    imageInput.value = dataUrl;
                    uploadForm.submit();
                    console.log('Image captured and form submitted.');
                } catch (err) {
                    console.error('Error in captureAndSend:', err);
                    alert('Lỗi khi xử lý ảnh. Vui lòng thử lại.');
                    setProcessingState(false);
                }
            }

            async function switchCamera() {
                // toggle facing mode
                currentFacing = (currentFacing === 'environment') ? 'user' : 'environment';
                // visual feedback
                flipBtn.disabled = true;
                flipBtn.classList.add('opacity-75');
                try {
                    await startCamera();
                } finally {
                    flipBtn.disabled = false;
                    flipBtn.classList.remove('opacity-75');
                }
            }

            // wire events
            snapBtn.addEventListener('click', captureAndSend);
            stopBtn.addEventListener('click', () => {
                stopCamera();
                setProcessingState(false);
                hideLoginPrompt();
            });
            flipBtn.addEventListener('click', switchCamera);

            // Handle file input change for library upload
            fileInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        stopCamera();
                        video.style.display = 'none';
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        video.parentNode.appendChild(img);
                        imageInput.value = e.target.result;
                        uploadForm.submit();
                    };
                    reader.readAsDataURL(file);
                }
                this.value = '';
            });

            // start camera on load
            window.addEventListener('load', startCamera);
            window.addEventListener('beforeunload', stopCamera);
        })();
    </script>
    <!--<script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const snapBtn = document.getElementById("snapBtn");
        const imageInput = document.getElementById("imageInput");
        const uploadForm = document.getElementById("uploadForm");
        const isAuthenticated = document.body.dataset.auth === "true";

        // Mở camera
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => { video.srcObject = stream; })
            .catch(err => { alert("Không thể mở camera: " + err); });

        // Xử lý khi bấm nút chụp
        snapBtn.onclick = function () {
            if (!isAuthenticated) {
                alert("Bạn cần đăng nhập để sử dụng chức năng này!");
                return;
            }

            if (!video || !video.srcObject || video.readyState < 4) {
                alert('Camera chưa sẵn sàng, vui lòng chờ và thử lại.');
                return;
            }

            // Additional check: ensure video has dimensions loaded
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                alert('Video chưa tải đầy đủ, vui lòng chờ và thử lại.');
                return;
            }

            if (video.paused || video.ended) {
                alert('Video không đang phát. Vui lòng thử lại.');
                return;
            }

            try {
                // Đặt kích thước canvas 300x300
                canvas.width = 300;
                canvas.height = 300;

                // Vẽ frame từ video vào canvas, scale to 300x300
                ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, 300, 300);

                // Lấy ảnh base64 từ canvas
                const dataUrl = canvas.toDataURL("image/png");

                // Gán ảnh base64 vào input hidden
                imageInput.value = dataUrl;

                // Submit form
                uploadForm.submit();
            } catch (err) {
                console.error('Lỗi khi chụp ảnh:', err);
                alert('Lỗi khi xử lý ảnh. Vui lòng thử lại.');
            }
        };
    </script>-->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>